#!/usr/bin/env bash
# [ -z "$1" ] && echo "Please specify the version to download (ex. 2.0.0)" && exit
source ./env/magento.env

TARGET_DIR=~/.magento-dockerlab
SRC_DIR=./src
mkdir -p $SRC_DIR

function repoExists() {
  CODE=$(curl -ILs "$2" | grep "HTTP/1.1" | tail -1 | cut -d$' ' -f2)
  if [ "$CODE" == "404" ]; then
    echo "The version $1 does not exist or is not available."
    exit 1
  fi
}

function downloadVersion() {
  repoExists $3 $1
  echo "Downloading Magento $3 version..."
  (cd $2 && curl -OLs $1)
}

function isTargetDirEmpty() {
  if [ -d $1 ] && [ "$(ls -A $1)" ]; then
      echo "The $1 directory is not empty."
      exit 1
  fi
}

isTargetDirEmpty $SRC_DIR

if [ -z "$MAGENTO_VERSION" ]; then
  V=latest
  echo "The latest version of Magento 2 will be used..."
else
  V="$MAGENTO_VERSION"
  echo "Using the version $V..."
fi

REPO=https://github.com/magedin/magento-opensource-releases/archive/$V.tar.gz
FILE_NAME=$V.tar.gz
LOCAL_FILE=$TARGET_DIR/$V.tar.gz

if [ ! -f $LOCAL_FILE ]; then
    downloadVersion $REPO $TARGET_DIR $V
fi

echo "Extracting Magento to ./src"
mkdir -p $SRC_DIR && tar xzf $LOCAL_FILE -o -C $SRC_DIR --strip 1

echo "Enjoy!"
exit 0
